<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODOã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-in': 'slideIn 0.3s ease-out'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <div class="bg-white rounded-2xl shadow-xl p-8 animate-fade-in">
            <h1 class="text-4xl font-bold text-center mb-8 text-gray-800 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                TODOã‚¢ãƒ—ãƒª
            </h1>
            
            <div class="mb-8">
                <div class="space-y-3">
                    <div class="flex gap-3">
                        <input 
                            type="text" 
                            id="newTask" 
                            placeholder="æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›..." 
                            class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors duration-200 text-gray-700 placeholder-gray-400"
                        >
                        <select 
                            id="prioritySelect" 
                            class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors duration-200 text-gray-700"
                        >
                            <option value="high">ğŸ”´ é«˜</option>
                            <option value="medium" selected>ğŸŸ¡ ä¸­</option>
                            <option value="low">ğŸŸ¢ ä½</option>
                        </select>
                    </div>
                    <div class="flex gap-3">
                        <input 
                            type="date" 
                            id="dueDateInput" 
                            class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors duration-200 text-gray-700"
                            title="æœŸé™æ—¥ã‚’è¨­å®šï¼ˆä»»æ„ï¼‰"
                        >
                        <input 
                            type="text" 
                            id="categoryInput" 
                            placeholder="ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰" 
                            class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors duration-200 text-gray-700 placeholder-gray-400"
                            list="categoryList"
                            maxlength="50"
                        >
                        <datalist id="categoryList"></datalist>
                        <button 
                            onclick="addTask()" 
                            class="px-8 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-200 transition-all duration-200 font-medium shadow-lg hover:shadow-xl transform hover:scale-105"
                        >
                            è¿½åŠ 
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
                <div class="flex gap-4">
                    <div class="flex gap-2 items-center">
                        <label for="categoryFilter" class="text-sm text-gray-600">ã‚«ãƒ†ã‚´ãƒª:</label>
                        <select 
                            id="categoryFilter" 
                            onchange="fetchTasks()" 
                            class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-blue-500"
                        >
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                    <div class="flex gap-2 items-center">
                        <label for="sortOrder" class="text-sm text-gray-600">ä¸¦ã³é †:</label>
                        <select 
                            id="sortOrder" 
                            onchange="fetchTasks()" 
                            class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-blue-500"
                        >
                            <option value="priority">å„ªå…ˆåº¦é †</option>
                            <option value="created">ä½œæˆæ—¥é †</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <ul id="taskList" class="space-y-3"></ul>
        </div>
    </div>

    <script>
        const BEARER_TOKEN = 'your-secret-token';
        
        function getAuthHeaders() {
            return {
                'Authorization': `Bearer ${BEARER_TOKEN}`,
                'Content-Type': 'application/json'
            };
        }
        
        function getPriorityIcon(priority) {
            switch(priority) {
                case 'high': return 'ğŸ”´';
                case 'medium': return 'ğŸŸ¡';
                case 'low': return 'ğŸŸ¢';
                default: return 'ğŸŸ¡';
            }
        }
        
        function getPriorityLabel(priority) {
            switch(priority) {
                case 'high': return 'é«˜';
                case 'medium': return 'ä¸­';
                case 'low': return 'ä½';
                default: return 'ä¸­';
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP', { 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function getDeadlineStatus(dueDate) {
            if (!dueDate) return null;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);
            
            const diffTime = due.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 'overdue';
            if (diffDays === 0) return 'today';
            if (diffDays === 1) return 'tomorrow';
            if (diffDays <= 3) return 'soon';
            return 'normal';
        }
        
        function getDeadlineDisplay(dueDate) {
            if (!dueDate) return '';
            
            const status = getDeadlineStatus(dueDate);
            const formatted = formatDate(dueDate);
            
            switch(status) {
                case 'overdue': return `âš ï¸ æœŸé™åˆ‡ã‚Œ (${formatted})`;
                case 'today': return `ğŸ”¥ ä»Šæ—¥æœŸé™`;
                case 'tomorrow': return `â° æ˜æ—¥æœŸé™`;
                case 'soon': return `ğŸ“… ${formatted}æœŸé™`;
                default: return `ğŸ“… ${formatted}`;
            }
        }
        
        function getCategoryColor(category) {
            if (!category) return null;
            
            // Generate a consistent color based on category name
            let hash = 0;
            for (let i = 0; i < category.length; i++) {
                hash = category.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const colors = [
                'bg-blue-100 text-blue-800',
                'bg-green-100 text-green-800',
                'bg-purple-100 text-purple-800',
                'bg-pink-100 text-pink-800',
                'bg-indigo-100 text-indigo-800',
                'bg-yellow-100 text-yellow-800',
                'bg-teal-100 text-teal-800',
                'bg-orange-100 text-orange-800'
            ];
            
            return colors[Math.abs(hash) % colors.length];
        }
        
        async function fetchCategories() {
            try {
                const res = await fetch('/categories', {
                    headers: { 'Authorization': `Bearer ${BEARER_TOKEN}` }
                });
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const categories = await res.json();
                
                // Update category filter dropdown
                const categoryFilter = document.getElementById('categoryFilter');
                const currentValue = categoryFilter.value;
                categoryFilter.innerHTML = '<option value="">ã™ã¹ã¦</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
                categoryFilter.value = currentValue;
                
                // Update category input datalist
                const categoryList = document.getElementById('categoryList');
                categoryList.innerHTML = '';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    categoryList.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching categories:', error);
            }
        }
        
        async function fetchTasks() {
            const res = await fetch('/tasks', {
                headers: { 'Authorization': `Bearer ${BEARER_TOKEN}` }
            });
            if (!res.ok) {
                if (res.status === 401) {
                    alert('èªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™');
                    return;
                }
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            let tasks = await res.json();
            
            // Filter tasks by category
            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter && categoryFilter.value) {
                tasks = tasks.filter(task => task.category === categoryFilter.value);
            }
            
            // Sort tasks based on selected order
            const sortOrder = document.getElementById('sortOrder').value;
            if (sortOrder === 'created') {
                tasks = tasks.reverse(); // Since they come pre-sorted by priority, reverse for creation order
            }
            
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            
            // Fetch and update categories
            await fetchCategories();
            
            if (tasks.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'text-center py-12 text-gray-500';

                const icon = document.createElement('div');
                icon.className = 'text-6xl mb-4';
                icon.textContent = 'ğŸ“';

                const msg1 = document.createElement('p');
                msg1.className = 'text-lg';
                msg1.textContent = 'ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“';

                const msg2 = document.createElement('p');
                msg2.className = 'text-sm';
                msg2.textContent = 'ä¸Šã®å…¥åŠ›æ¬„ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„';

                emptyState.appendChild(icon);
                emptyState.appendChild(msg1);
                emptyState.appendChild(msg2);
                list.appendChild(emptyState);
                return;
            }
            
            tasks.forEach((task, i) => {
                const li = document.createElement('li');
                li.className = 'bg-gray-50 rounded-xl p-4 border border-gray-200 hover:border-blue-300 transition-all duration-200 animate-slide-in';
                li.style.animationDelay = `${i * 50}ms`;

                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center justify-between';

                const taskContent = document.createElement('div');
                taskContent.className = 'flex-1 mr-4';
                
                const topRow = document.createElement('div');
                topRow.className = 'flex items-center mb-1';
                
                const priorityBadge = document.createElement('span');
                priorityBadge.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium mr-3';
                priorityBadge.textContent = `${getPriorityIcon(task.priority)} ${getPriorityLabel(task.priority)}`;
                
                // Priority-specific styling
                switch(task.priority) {
                    case 'high':
                        priorityBadge.className += ' bg-red-100 text-red-800';
                        break;
                    case 'medium':
                        priorityBadge.className += ' bg-yellow-100 text-yellow-800';
                        break;
                    case 'low':
                        priorityBadge.className += ' bg-green-100 text-green-800';
                        break;
                    default:
                        priorityBadge.className += ' bg-yellow-100 text-yellow-800';
                }

                const span = document.createElement('span');
                span.className = 'text-gray-800 font-medium';
                span.textContent = task.text;
                
                topRow.appendChild(priorityBadge);
                
                // Add category badge if exists
                if (task.category) {
                    const categoryBadge = document.createElement('span');
                    categoryBadge.className = `inline-flex items-center px-2 py-1 rounded-full text-xs font-medium mr-3 ${getCategoryColor(task.category)}`;
                    categoryBadge.textContent = `ğŸ·ï¸ ${task.category}`;
                    topRow.appendChild(categoryBadge);
                }
                
                topRow.appendChild(span);
                
                taskContent.appendChild(topRow);
                
                // Add deadline display if exists
                if (task.due_date) {
                    const deadlineRow = document.createElement('div');
                    deadlineRow.className = 'text-sm mt-1';
                    
                    const deadlineSpan = document.createElement('span');
                    const status = getDeadlineStatus(task.due_date);
                    
                    // Style based on deadline status
                    switch(status) {
                        case 'overdue':
                            deadlineSpan.className = 'text-red-600 font-semibold';
                            break;
                        case 'today':
                            deadlineSpan.className = 'text-red-500 font-semibold';
                            break;
                        case 'tomorrow':
                            deadlineSpan.className = 'text-orange-500 font-medium';
                            break;
                        case 'soon':
                            deadlineSpan.className = 'text-yellow-600 font-medium';
                            break;
                        default:
                            deadlineSpan.className = 'text-gray-600';
                    }
                    
                    deadlineSpan.textContent = getDeadlineDisplay(task.due_date);
                    deadlineRow.appendChild(deadlineSpan);
                    taskContent.appendChild(deadlineRow);
                }

                const btnContainer = document.createElement('div');
                btnContainer.className = 'flex gap-2';

                const editBtn = document.createElement('button');
                editBtn.className = 'px-3 py-1.5 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors duration-200 text-sm font-medium';
                editBtn.textContent = 'âœï¸ ç·¨é›†';
                editBtn.addEventListener('click', () => editTask(i, task));

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'px-3 py-1.5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors duration-200 text-sm font-medium';
                deleteBtn.textContent = 'ğŸ—‘ï¸ å‰Šé™¤';
                deleteBtn.addEventListener('click', () => deleteTask(i));

                btnContainer.appendChild(editBtn);
                btnContainer.appendChild(deleteBtn);

                wrapper.appendChild(taskContent);
                wrapper.appendChild(btnContainer);
                li.appendChild(wrapper);

                list.appendChild(li);
            });
        }
        async function addTask() {
            const input = document.getElementById('newTask');
            const prioritySelect = document.getElementById('prioritySelect');
            const dueDateInput = document.getElementById('dueDateInput');
            const categoryInput = document.getElementById('categoryInput');
            const task = input.value.trim();
            const priority = prioritySelect.value;
            const dueDate = dueDateInput.value || null;
            const category = categoryInput.value.trim() || null;
            if (!task) return;
            try {
                const requestBody = { task, priority };
                if (dueDate) {
                    requestBody.due_date = dueDate;
                }
                if (category) {
                    requestBody.category = category;
                }
                
                const res = await fetch('/tasks', { 
                    method: 'POST', 
                    headers: getAuthHeaders(), 
                    body: JSON.stringify(requestBody) 
                });
                if (!res.ok) {
                    if (res.status === 401) {
                        alert('èªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™');
                        return;
                    }
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                input.value = '';
                prioritySelect.value = 'medium';
                dueDateInput.value = '';
                categoryInput.value = '';
                fetchTasks();
            } catch (error) {
                console.error('Error adding task:', error);
                alert('ã‚¿ã‚¹ã‚¯ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        async function deleteTask(index) {
            try {
                const res = await fetch(`/tasks/${index}`, { 
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${BEARER_TOKEN}` }
                });
                if (!res.ok) {
                    if (res.status === 401) {
                        alert('èªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™');
                        return;
                    }
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                fetchTasks();
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        async function editTask(index, currentTask) {
            const newTask = prompt('ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†:', currentTask.text);
            if (!newTask || newTask.trim() === currentTask.text) return;
            
            // Priority selection dialog
            const priorityChoice = prompt(
                `å„ªå…ˆåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„:\n1: ğŸ”´ é«˜\n2: ğŸŸ¡ ä¸­\n3: ğŸŸ¢ ä½\n\nç¾åœ¨: ${getPriorityLabel(currentTask.priority)}\n\næ•°å­—ã‚’å…¥åŠ› (1-3):`
            );
            
            let priority = currentTask.priority;
            if (priorityChoice === '1') priority = 'high';
            else if (priorityChoice === '2') priority = 'medium';
            else if (priorityChoice === '3') priority = 'low';
            
            // Due date selection dialog
            const currentDueDate = currentTask.due_date || '';
            const dueDateChoice = prompt(
                `æœŸé™æ—¥ã‚’è¨­å®šã—ã¦ãã ã•ã„ (YYYY-MM-DDå½¢å¼):\n\nç¾åœ¨: ${currentDueDate || 'è¨­å®šãªã—'}\n\nç©ºç™½ã§æœŸé™ãªã—:`
            );
            
            let dueDate = currentTask.due_date;
            if (dueDateChoice !== null) {
                dueDate = dueDateChoice.trim() || null;
            }
            
            // Category selection dialog
            const currentCategory = currentTask.category || '';
            const categoryChoice = prompt(
                `ã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®šã—ã¦ãã ã•ã„:\n\nç¾åœ¨: ${currentCategory || 'è¨­å®šãªã—'}\n\nç©ºç™½ã§ã‚«ãƒ†ã‚´ãƒªãªã—:`
            );
            
            let category = currentTask.category;
            if (categoryChoice !== null) {
                category = categoryChoice.trim() || null;
            }
            
            try {
                const requestBody = { task: newTask.trim(), priority };
                if (dueDate !== undefined) {
                    requestBody.due_date = dueDate;
                }
                if (category !== undefined) {
                    requestBody.category = category;
                }
                
                const res = await fetch(`/tasks/${index}`, { 
                    method: 'PUT', 
                    headers: getAuthHeaders(), 
                    body: JSON.stringify(requestBody) 
                });
                if (!res.ok) {
                    if (res.status === 401) {
                        alert('èªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™');
                        return;
                    }
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                fetchTasks();
            } catch (error) {
                console.error('Error editing task:', error);
                alert('ã‚¿ã‚¹ã‚¯ã®ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // Enter key support for adding tasks
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('newTask');
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTask();
                }
            });
        });
        fetchTasks();
    </script>
</body>
</html>
